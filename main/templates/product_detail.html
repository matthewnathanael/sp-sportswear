{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title id="meta-title">Product Details</title>
{% endblock meta %}

{% block content %}
<div class="bg-amber-50 w-full min-h-screen">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <div class="mb-6">
            <a href="{% url 'main:show_main' %}"
                class="text-stone-700 hover:text-stone-800 font-medium transition-colors flex items-center space-x-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                <span>Back to Product List</span>
            </a>
        </div>

        <input type="hidden" id="product-id" value="{{ product.id }}">

        <div id="loading-state" class="bg-white rounded-lg border border-amber-200 p-12 text-center">
            <svg class="animate-spin h-8 w-8 text-stone-700 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            <p class="text-gray-700 mt-3">Memuat detail produk...</p>
        </div>

        <div id="error-state" class="bg-red-100 rounded-lg border border-red-400 text-red-700 p-8 mb-4 hidden"
            role="alert">
            <p class="font-bold">Error!</p>
            <p id="error-message">Gagal memuat detail produk. Silakan coba refresh halaman.</p>
        </div>

        <article id="product-article" class="bg-white rounded-xl overflow-hidden 
             border-2 border-stone-700 
             shadow-[6px_6px_0_0_rgba(68,64,60,1)] 
             transition-shadow duration-150 ease-out hidden">

            <div class="p-6 sm:p-8">

                <div id="product-badges-container" class="flex flex-wrap items-center gap-2 mb-4">
                </div>

                <h1 id="product-name" class="text-3xl sm:text-4xl font-bold text-gray-900 leading-tight mb-4">
                </h1>

                <div class="flex flex-wrap items-center text-lg font-semibold text-gray-700 gap-6 border-b pb-4 mb-4">
                    <p id="product-price" class="text-3xl font-extrabold text-stone-700 font-price">
                    </p>
                    <p class="text-base text-gray-600">
                        Stok: <span id="product-stock" class="font-bold text-gray-900"></span>
                    </p>
                    <p id="product-rating-container" class="text-base text-gray-600 flex items-center space-x-1 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-500" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path
                                d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.381-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                        <span id="product-rating" class="font-bold text-gray-900"></span>
                    </p>
                </div>

            </div>

            <div id="product-image-container" class="px-6 sm:px-8 pb-4 hidden">
                <img id="product-image" src="" alt=""
                    class="w-full h-80 object-contain rounded-lg border border-gray-100">
            </div>

            <div class="p-6 sm:p-8">
                <h2 class="text-2xl font-semibold text-gray-900 mb-4">Description</h2>
                <div class="prose max-w-none">
                    <p id="product-description" class="text-gray-700 leading-relaxed text-base sm:text-lg">
                    </p>
                </div>
                <div class="mt-4">
                    <p class="text-sm font-medium text-gray-600">Brand</p>
                    <p id="product-brand" class="text-lg font-medium text-gray-900"></p>
                </div>
            </div>

            <div class="border-t-4 border-stone-700 p-6 sm:p-8 bg-amber-50">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">
                            Seller
                        </p>
                        <div id="product-seller" class="text-lg font-medium text-gray-900">
                        </div>
                    </div>
                </div>
            </div>

        </article>
    </div>
</div>
<script>
    // Configuration
    const PRODUCT_ID = document.getElementById('product-id').value;
    const UUID_PLACEHOLDER = '00000000-0000-0000-0000-000000000000';
    // Menggunakan URL show_json_by_id dan mengganti placeholder '0' dengan ID
    const PRODUCT_DETAIL_ENDPOINT = `{% url 'main:show_json_by_id' '00000000-0000-0000-0000-000000000000' %}`.replace(UUID_PLACEHOLDER, PRODUCT_ID);

    // DOM Elements
    const metaTitle = document.getElementById('meta-title');
    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');
    const errorMessage = document.getElementById('error-message');
    const productArticle = document.getElementById('product-article');
    const badgesContainer = document.getElementById('product-badges-container');
    const productName = document.getElementById('product-name');
    const productPrice = document.getElementById('product-price');
    const productStock = document.getElementById('product-stock');
    const productRatingContainer = document.getElementById('product-rating-container');
    const productRating = document.getElementById('product-rating');
    const productImageContainer = document.getElementById('product-image-container');
    const productImage = document.getElementById('product-image');
    const productDescription = document.getElementById('product-description');
    const productSeller = document.getElementById('product-seller');
    const productBrand = document.getElementById('product-brand');

    // Show/hide page sections
    function showState(state) {
        loadingState.classList.toggle('hidden', state !== 'loading');
        errorState.classList.toggle('hidden', state !== 'error');
        productArticle.classList.toggle('hidden', state !== 'ready');
    }

    // Get readable category name (Disusuaikan untuk Product categories)
    function getCategoryLabel(categoryCode) {
        const categoryMapping = {
            jersey: 'Jersey',
            sweater: 'Sweater',
            baju: 'Baju',
            celana: 'Celana',
            sepatu: 'Sepatu',
            tas: 'Tas',
            sleeve: 'Sleeves',
            'kaos kaki': 'Kaos Kaki',
            lain: 'Lainnya',
            update: 'Update',
        };
        return categoryMapping[categoryCode] || categoryCode;
    }

    // Fungsi untuk format harga Rupiah
    function formatRupiah(number) {
        if (typeof number !== 'number' || isNaN(number)) return 'Rp 0';
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(number).replace('IDR', 'Rp');
    }

    // Render product content
    function renderProduct(product) {
        // Set title
        productName.textContent = product.name;
        metaTitle.textContent = `${product.name} - Product Details`;

        // Set badges
        badgesContainer.innerHTML = '';

        // Category badge
        const categoryBadge = document.createElement('span');
        categoryBadge.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-amber-100 text-stone-800 border border-amber-300';
        categoryBadge.textContent = getCategoryLabel(product.category);
        badgesContainer.appendChild(categoryBadge);

        // Featured badge
        if (product.is_featured) {
            const featuredBadge = document.createElement('span');
            featuredBadge.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-orange-200 text-orange-900';
            featuredBadge.textContent = 'Featured';
            badgesContainer.appendChild(featuredBadge);
        }

        // Set price, stock, and brand
        productPrice.textContent = formatRupiah(product.price);
        productStock.textContent = product.stock;
        productBrand.textContent = product.brand || 'N/A';

        // Set rating
        if (product.rating !== null && product.rating !== 0) {
            productRatingContainer.classList.remove('hidden');
            productRating.textContent = product.rating;
        } else {
            productRatingContainer.classList.add('hidden');
        }

        // Set thumbnail
        if (product.thumbnail) {
            productImage.src = product.thumbnail;
            productImage.alt = product.name;
            productImageContainer.classList.remove('hidden');
        } else {
            productImageContainer.classList.add('hidden');
        }

        // Set content (description)
        productDescription.textContent = product.description;

        // Set seller
        const sellerName = product.user_username || 'Anonymous';
        productSeller.textContent = sellerName;
    }

    // Fetch product detail
    async function loadProductDetail() {
        if (!PRODUCT_ID) {
            showState('error');
            errorMessage.textContent = 'Product ID tidak ditemukan di halaman.';
            return;
        }

        try {
            showState('loading');

            const response = await fetch(PRODUCT_DETAIL_ENDPOINT, {
                headers: { 'Accept': 'application/json' },
            });

            if (response.status === 404) {
                showState('error');
                errorMessage.textContent = 'Produk tidak ditemukan.';
                return;
            }

            if (!response.ok) {
                throw new Error('Failed to fetch product detail');
            }

            const productData = await response.json();
            renderProduct(productData);
            showState('ready');
        } catch (error) {
            console.error('Error loading product detail:', error);
            showState('error');
            errorMessage.textContent = 'Gagal memuat detail produk. Silakan coba refresh halaman.';
        }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', loadProductDetail);
</script>
{% endblock content %}